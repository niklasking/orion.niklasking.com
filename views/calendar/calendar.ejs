<% include ../partials/header %>

<script src='/static/js/fullcalendar_sv.js'></script>
<link rel="stylesheet" href="/static/css/calendar.css">
<link rel="stylesheet" href="https://unpkg.com/leaflet@1.4.0/dist/leaflet.css" integrity="sha512-puBpdR0798OZvTTbP4A8Ix/l+A4dHDD0DGqYW6RQ+9jxkRFclaxxQb/SJAWZfWAkuyeQUytO7+7N4QKrDh+drA==" crossorigin="">
<script src="https://unpkg.com/leaflet@1.4.0/dist/leaflet.js" integrity="sha512-QVftwZFqvtRNi0ZyCtsznlKSWOStnDORoefr1enyq5mVL4tmKB3S/EnC3rRJcxCPavG10IcrVGSmPh6Qw5lwrg==" crossorigin=""></script>

<script>
    $(function() {
        $('#calendar').fullCalendar({
            locale: 'sv',
            firstDay: 1,
            height: "auto",
            defaultView: 'month',
            timezone: 'local',
            weekNumbers: true,
            header: {
                left: 'month,basicWeek,listMonth',
                center: 'title',
                right: 'today,prev,next'
            },
            events: <%- JSON.stringify(event_list) %>,
            eventClick: function(calEvent, jsEvent, view) {
                location.replace("/kalender?title=" + calEvent.title + 
                    "&date=" + moment(calEvent.start).format("YYYY-MM-DD HH:mm") +
                    "&className=" + calEvent.className +
                    "&lat=" + calEvent.lat +
                    "&lng=" + calEvent.lng +
                    "&link=" + calEvent.link +
                    "&ansvarig=" + calEvent.ansvarig +
                    "&description=" + calEvent.description + 
                    "&_id=" + calEvent._id);
            },
            eventRender: function(event, eventElement) {
                if (event.className == "eventTraining") {
                    eventElement.find("div.fc-content").prepend(" <img src='/static/imgs/activity_type_1.gif' width='16' height='16'> ");
                }
                else if (event.className == "eventCompetition") {
                    eventElement.find("div.fc-content").prepend(" <img src='/static/imgs/activity_type_2.gif' width='16' height='16'> ");
                }
                else if (event.className == "eventMeeting") {
                    eventElement.find("div.fc-content").prepend(" <img src='/static/imgs/activity_type_3.gif' width='16' height='16'> ");
                }
                else if (event.className == "eventImportant") {
                    eventElement.find("div.fc-content").prepend(" <img src='/static/imgs/activity_type_4.gif' width='16' height='16'> ");
                }
            }
        });
    });
</script>
<div class="container">
    <% if (_id != undefined) { %>
        <div class="row">
            <div class="col">
                <h1><%= title %></h1>
            </div>
        </div>
        <div class="row">
            <div class="col-2">
                <strong>Tid och datum:</strong>
            </div>
            <div class="col-10">
                <%= date %>
            </div>
        </div>
        <% if (description != undefined && description.length > 0) { %>
            <div class="row">
                <div class="col my-3">
                    <%= description %>
                </div>
            </div>
        <% } %>
        <% if (ansvarig != undefined && ansvarig.length > 0) { %>
            <div class="row">
                <div class="col-2">
                    <strong>Ansvarig:</strong>
                </div>
                <div class="col-10">
                    <%= ansvarig %>
                </div>
            </div>
        <% } %>
        <% if (link != undefined && link.length > 0) { %>
            <div class="row">
                <div class="col-2">
                    <strong>Mer info:</strong>
                </div>
                <div class="col-10">
                    <a href="<%= link %>"><%= link %></a>
                </div>
            </div>
        <% } %>
    <% } %>
    <% if (lat != undefined && lat != "" && lng != undefined && lng != "") { %>
        <div id="mapid"></div>
    <% } %>
    <hr>
    <div class="row">
        <div class="col mb-5">
            <h1>Kalender</h1>
            <div id="calendar"></div>
        </div>
    </div>
</div>

<script>
    // const urlParams = new URLSearchParams(window.location.search);
    // const lat = urlParams.get('lat');
    // const lng = urlParams.get('lng');
    var lat = '<%= lat %>';
    var lng = '<%= lng %>';

    if (lat != "" && lng != "") {
        var mymap = L.map('mapid').setView([lat, lng], 11);

        L.tileLayer('https://api.tiles.mapbox.com/v4/{id}/{z}/{x}/{y}.png?access_token=pk.eyJ1IjoibWFwYm94IiwiYSI6ImNpejY4NXVycTA2emYycXBndHRqcmZ3N3gifQ.rJcFIG214AriISLbB6B5aw', {
            maxZoom: 18,
            attribution: 'Map data &copy; <a href="https://www.openstreetmap.org/">OpenStreetMap</a> contributors, ' +
                '<a href="https://creativecommons.org/licenses/by-sa/2.0/">CC-BY-SA</a>, ' +
                'Imagery Â© <a href="https://www.mapbox.com/">Mapbox</a>',
            id: 'mapbox.streets'
        }).addTo(mymap);

        var marker;
        marker = new L.Marker([lat, lng]);
        marker.addTo(mymap);
    }
</script>
<% include ../partials/footer %>